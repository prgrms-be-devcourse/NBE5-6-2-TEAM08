<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>DateNow – 회원가입</title>
  <style>
    body {
      margin: 0;
      background-color: #FFF2F8;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .signin-container {
      max-width: 400px;
      margin: 0 auto;
      padding: 80px 20px 40px;
      text-align: center;
    }
    .logo {
      font-size: 32px;
      font-weight: bold;
      color: #FF4DA1;
      margin-bottom: 60px;
    }
    .field { margin-bottom: 20px; text-align: left; }
    .field label { font-size: 14px; color: #333; margin-bottom: 8px; display: block; }
    .field input {
      width: 100%; height: 44px; padding: 0 12px;
      border: 1px solid #E3E3E3; border-radius: 22px;
      font-size: 16px; box-sizing: border-box;
    }
    .check-btn {
      margin-top: 8px;
      font-size: 12px;
      padding: 6px 12px;
      background-color: #ff4da1;
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }
    .error-field {
      color: red;
      font-size: 12px;
      margin-top: 4px;
    }
    .success-field {
      color: green;
      font-size: 12px;
      margin-top: 4px;
    }
    .btn-login {
      width: 100%; height: 50px;
      background-color: #FF4DA1;
      color: white; font-size: 16px;
      border: none; border-radius: 25px;
      margin-top: 10px; cursor: pointer;
    }
    .btn-login:disabled {
      background-color: #FFC0D1;
    }
  </style>
</head>
<body>
<div class="signin-container">
  <h1 class="logo">💖 DateNow.</h1>

  <form th:action="@{/member/signup}" th:object="${signupRequest}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <!-- 아이디 -->
    <div class="field">
      <label for="userId">아이디</label>
      <input type="text" id="userId" th:field="*{userId}" placeholder="아이디를 입력하세요.">
      <div id="userId-msg" class="error-field"></div>
    </div>

    <!-- 비밀번호 -->
    <div class="field">
      <label for="password">비밀번호</label>
      <input type="password" id="password" th:field="*{password}" placeholder="비밀번호를 입력하세요.">
    </div>

    <!-- 비밀번호 확인 -->
    <div class="field">
      <label for="confirmPassword">비밀번호 확인</label>
      <input type="password" id="confirmPassword" placeholder="비밀번호를 다시 입력하세요.">
      <div id="password-msg" class="error-field"></div>
    </div>

    <!-- 이메일 -->
    <div class="field">
      <label for="email">이메일</label>
      <input type="email" id="email" th:field="*{email}" placeholder="이메일을 입력하세요.">
      <div id="email-msg" class="error-field"></div>
    </div>

    <!-- 닉네임 -->
    <div class="field">
      <label for="nickname">닉네임</label>
      <input type="text" id="nickname" th:field="*{nickname}" placeholder="닉네임을 입력하세요.">
      <div id="nickname-msg" class="error-field"></div>
    </div>


    <!-- 이름 -->
    <div class="field">
      <label for="name">이름</label>
      <input type="text" id="name" th:field="*{name}" placeholder="이름을 입력하세요.">
    </div>

    <!-- 생년월일 -->
    <div class="field">
      <label for="birth">생년월일</label>
      <input type="text" id="birth" th:field="*{birth}" placeholder="YYYY-MM-DD">
    </div>

    <!-- 전화번호 -->
    <div class="field">
      <label for="phone">전화번호</label>
      <input type="text" id="phone" th:field="*{phone}" placeholder="전화번호를 입력하세요.">
    </div>

    <!-- 제출 버튼 -->
    <button type="submit" id="submitBtn" class="btn-login" disabled>회원가입 완료</button>
  </form>
</div>

<script>
  const isValid = {
    userId: false,
    email: false,
    nickname: false,
    password: false
  };

  const apiMap = {
    userId: '/api/members/exists/userId?userId=',
    email: '/api/members/check/email?email=',
    nickname: '/api/members/check/nickname?nickname='
  };

  function updateSubmitButton() {
    const allValid = Object.values(isValid).every(Boolean);
    document.getElementById('submitBtn').disabled = !allValid;
  }

  function checkDuplication(field) {
    const value = document.getElementById(field).value.trim();
    const msgElement = document.getElementById(`${field}-msg`);

    if (!value) {
      msgElement.textContent = '값을 입력하세요.';
      msgElement.className = 'error-field';
      isValid[field] = false;
      updateSubmitButton();
      return;
    }

    fetch(apiMap[field] + encodeURIComponent(value))
    .then(res => res.json())
    .then(json => {
      if (!json.data) {
        msgElement.textContent = '사용 가능한 값입니다.';
        msgElement.className = 'success-field';
        isValid[field] = true;
      } else {
        msgElement.textContent = '이미 사용 중인 값입니다.';
        msgElement.className = 'error-field';
        isValid[field] = false;
      }
      updateSubmitButton();
    })
    .catch(() => {
      msgElement.textContent = '중복 검사 중 오류 발생';
      msgElement.className = 'error-field';
      isValid[field] = false;
      updateSubmitButton();
    });
  }

  function checkPasswordMatch() {
    const pw = document.getElementById('password').value;
    const confirm = document.getElementById('confirmPassword').value;
    const msg = document.getElementById('password-msg');

    if (pw && confirm && pw === confirm) {
      msg.textContent = '비밀번호가 일치합니다.';
      msg.className = 'success-field';
      isValid.password = true;
    } else {
      msg.textContent = '비밀번호가 일치하지 않습니다.';
      msg.className = 'error-field';
      isValid.password = false;
    }
    updateSubmitButton();
  }

  document.getElementById('userId').addEventListener('input', () => checkDuplication('userId'));
  document.getElementById('email').addEventListener('input', () => checkDuplication('email'));
  document.getElementById('nickname').addEventListener('input', () => checkDuplication('nickname'));
  document.getElementById('password').addEventListener('input', checkPasswordMatch);
  document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);

  document.querySelector('form').addEventListener('submit', function (e) {
    e.preventDefault(); // 기본 제출 막기

    const data = {
      userId: document.getElementById('userId').value,
      password: document.getElementById('password').value,
      email: document.getElementById('email').value,
      name: document.getElementById('name').value,
      nickname: document.getElementById('nickname').value,
      birth: document.getElementById('birth').value,
      phone: document.getElementById('phone').value
    };

    fetch('/api/members/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) throw new Error('회원가입 실패');
      return res.json();
    })
    .then(json => {
      alert(json.data.message || '회원가입이 완료되었습니다.');
      window.location.href = '/signin'; //
    })
    .catch(err => {
      alert('회원가입 중 오류가 발생했습니다.');
      console.error(err);
    });
  });
</script>
</body>
</html>