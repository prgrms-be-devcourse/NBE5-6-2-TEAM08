<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>DateNow â€“ íšŒì›ê°€ì…</title>
  <style>
    body {
      margin: 0;
      background-color: #FFF2F8;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .signin-container {
      max-width: 400px;
      margin: 0 auto;
      padding: 80px 20px 40px;
      text-align: center;
    }
    .logo {
      font-size: 32px;
      font-weight: bold;
      color: #FF4DA1;
      margin-bottom: 60px;
    }
    .field { margin-bottom: 20px; text-align: left; }
    .field label { font-size: 14px; color: #333; margin-bottom: 8px; display: block; }
    .field input {
      width: 100%; height: 44px; padding: 0 12px;
      border: 1px solid #E3E3E3; border-radius: 22px;
      font-size: 16px; box-sizing: border-box;
    }
    .check-btn {
      margin-top: 8px;
      font-size: 12px;
      padding: 6px 12px;
      background-color: #ff4da1;
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }
    .error-field {
      color: red;
      font-size: 12px;
      margin-top: 4px;
    }
    .success-field {
      color: green;
      font-size: 12px;
      margin-top: 4px;
    }
    .btn-login {
      width: 100%; height: 50px;
      background-color: #FF4DA1;
      color: white; font-size: 16px;
      border: none; border-radius: 25px;
      margin-top: 10px; cursor: pointer;
    }
    .btn-login:disabled {
      background-color: #FFC0D1;
    }
  </style>
</head>
<body>
<div class="signin-container">
  <h1 class="logo">ğŸ’– DateNow.</h1>

  <form th:action="@{/member/signup}" th:object="${signupRequest}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <!-- ì•„ì´ë”” -->
    <div class="field">
      <label for="userId">ì•„ì´ë””</label>
      <input type="text" id="userId" th:field="*{userId}" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
      <div id="userId-msg" class="error-field"></div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ -->
    <div class="field">
      <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="password" th:field="*{password}" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
    <div class="field">
      <label for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
      <input type="password" id="confirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.">
      <div id="password-msg" class="error-field"></div>
    </div>

    <!-- ì´ë©”ì¼ -->
    <div class="field">
      <label for="email">ì´ë©”ì¼</label>
      <input type="email" id="email" th:field="*{email}" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.">
      <div id="email-msg" class="error-field"></div>
    </div>

    <!-- ë‹‰ë„¤ì„ -->
    <div class="field">
      <label for="nickname">ë‹‰ë„¤ì„</label>
      <input type="text" id="nickname" th:field="*{nickname}" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.">
      <div id="nickname-msg" class="error-field"></div>
    </div>


    <!-- ì´ë¦„ -->
    <div class="field">
      <label for="name">ì´ë¦„</label>
      <input type="text" id="name" th:field="*{name}" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">
    </div>

    <!-- ìƒë…„ì›”ì¼ -->
    <div class="field">
      <label for="birth">ìƒë…„ì›”ì¼</label>
      <input type="text" id="birth" th:field="*{birth}" placeholder="YYYY-MM-DD">
    </div>

    <!-- ì „í™”ë²ˆí˜¸ -->
    <div class="field">
      <label for="phone">ì „í™”ë²ˆí˜¸</label>
      <input type="text" id="phone" th:field="*{phone}" placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
    </div>

    <!-- ì œì¶œ ë²„íŠ¼ -->
    <button type="submit" id="submitBtn" class="btn-login" disabled>íšŒì›ê°€ì… ì™„ë£Œ</button>
  </form>
</div>

<script>
  const isValid = {
    userId: false,
    email: false,
    nickname: false,
    password: false
  };

  const apiMap = {
    userId: '/api/members/exists/userId?userId=',
    email: '/api/members/check/email?email=',
    nickname: '/api/members/check/nickname?nickname='
  };

  function updateSubmitButton() {
    const allValid = Object.values(isValid).every(Boolean);
    document.getElementById('submitBtn').disabled = !allValid;
  }

  function checkDuplication(field) {
    const value = document.getElementById(field).value.trim();
    const msgElement = document.getElementById(`${field}-msg`);

    if (!value) {
      msgElement.textContent = 'ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.';
      msgElement.className = 'error-field';
      isValid[field] = false;
      updateSubmitButton();
      return;
    }

    fetch(apiMap[field] + encodeURIComponent(value))
    .then(res => res.json())
    .then(json => {
      if (!json.data) {
        msgElement.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ê°’ì…ë‹ˆë‹¤.';
        msgElement.className = 'success-field';
        isValid[field] = true;
      } else {
        msgElement.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê°’ì…ë‹ˆë‹¤.';
        msgElement.className = 'error-field';
        isValid[field] = false;
      }
      updateSubmitButton();
    })
    .catch(() => {
      msgElement.textContent = 'ì¤‘ë³µ ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
      msgElement.className = 'error-field';
      isValid[field] = false;
      updateSubmitButton();
    });
  }

  function checkPasswordMatch() {
    const pw = document.getElementById('password').value;
    const confirm = document.getElementById('confirmPassword').value;
    const msg = document.getElementById('password-msg');

    if (pw && confirm && pw === confirm) {
      msg.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.';
      msg.className = 'success-field';
      isValid.password = true;
    } else {
      msg.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      msg.className = 'error-field';
      isValid.password = false;
    }
    updateSubmitButton();
  }

  document.getElementById('userId').addEventListener('input', () => checkDuplication('userId'));
  document.getElementById('email').addEventListener('input', () => checkDuplication('email'));
  document.getElementById('nickname').addEventListener('input', () => checkDuplication('nickname'));
  document.getElementById('password').addEventListener('input', checkPasswordMatch);
  document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);

  document.querySelector('form').addEventListener('submit', function (e) {
    e.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë§‰ê¸°

    const data = {
      userId: document.getElementById('userId').value,
      password: document.getElementById('password').value,
      email: document.getElementById('email').value,
      name: document.getElementById('name').value,
      nickname: document.getElementById('nickname').value,
      birth: document.getElementById('birth').value,
      phone: document.getElementById('phone').value
    };

    fetch('/api/members/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) throw new Error('íšŒì›ê°€ì… ì‹¤íŒ¨');
      return res.json();
    })
    .then(json => {
      alert(json.data.message || 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      window.location.href = '/signin'; //
    })
    .catch(err => {
      alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(err);
    });
  });
</script>
</body>
</html>